<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Model Showcase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root {
      --main-bg: #f5f7fa;
      --viewer-bg: #fff;
      --text-main: #222;
      --primary: #1976d2;
      --select-bg: #fff;
      --select-border: #bbb;
      --select-color: #222;
      --desc-color: #333;
      --shadow: 0 2px 16px #0001;
    }
    body.night {
      --main-bg: #181e28;
      --viewer-bg: #232b39;
      --text-main: #f3f6fa;
      --primary: #5caaff;
      --select-bg: #232b39;
      --select-border: #5caaff;
      --select-color: #f3f6fa;
      --desc-color: #a0bbd6;
      --shadow: 0 2px 16px #0004;
    }
    body {
      font-family: sans-serif;
      background: var(--main-bg);
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2em 0;
      color: var(--text-main);
      transition: background 0.35s, color 0.35s;
    }
    h1 {
      color: var(--primary);
      margin-bottom: 1em;
      transition: color 0.35s;
    }
    .controls {
      margin-bottom: 1.5em;
      display: flex;
      gap: 1em;
      flex-wrap: wrap;
      justify-content: center;
    }
    label {
      font-weight: bold;
      margin-right: 0.5em;
    }
    select {
      font-size: 1em;
      padding: 0.3em 0.7em;
      border-radius: 6px;
      border: 1px solid var(--select-border);
      background: var(--select-bg);
      color: var(--select-color);
      transition: background 0.35s, color 0.35s, border 0.35s;
    }
    #viewer-wrapper {
      width: 85vw;
      max-width: 1200px;
      min-width: 250px;
      height: 48vw;
      max-height: 600px;
      min-height: 220px;
      background: var(--viewer-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      margin-bottom: 2em;
      transition: background 0.35s, box-shadow 0.35s, height 0.3s, width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #viewer-wrapper.bg-has-img {
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    model-viewer {
      width: 100%;
      height: 100%;
      background: transparent;
    }
    @media (max-width: 900px) {
      #viewer-wrapper {
        width: 99vw;
        height: 220px;
        max-width: 100vw;
        max-height: 350px;
      }
    }
    .desc {
      font-size: 1.1em;
      color: var(--desc-color);
      margin-bottom: 2em;
      transition: color 0.35s;
      text-align: center;
    }
    .btn-bar {
      display: flex;
      gap: 1em;
      margin-bottom: 1.2em;
      justify-content: center;
    }
    .switch-btn {
      padding: 0.4em 1.2em;
      font-size: 1em;
      border-radius: 30px;
      border: 1.5px solid var(--primary);
      background: var(--viewer-bg);
      color: var(--primary);
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border 0.2s;
      outline: none;
      box-shadow: 0 1px 4px #0002;
    }
    .switch-btn:active, .switch-btn:focus {
      background: var(--primary);
      color: var(--viewer-bg);
    }
    body.night .switch-btn {
      background: var(--viewer-bg);
      color: var(--primary);
      border-color: var(--primary);
    }
    body.night .switch-btn:active, body.night .switch-btn:focus {
      background: var(--primary);
      color: var(--viewer-bg);
    }
    .bg-controls {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5em;
      margin-bottom: 1.2em;
      width: 100%;
    }
    #bgUpload, #clearBgBtn {
      font-size: 1em;
      margin: 0;
    }
  </style>
</head>
<body>
  <h1 id="title">3D Model Showcase</h1>
  <div class="btn-bar">
    <button class="switch-btn" id="langSwitch" aria-label="Switch to Hebrew">ðŸ‡®ðŸ‡± ×¢×‘×¨×™×ª</button>
    <button class="switch-btn" id="nightSwitch" aria-label="Switch to Night Mode">ðŸŒ™ Night Mode</button>
    <button class="switch-btn" id="variantSwitch" style="display:none"></button>
  </div>
  <div class="controls">
    <div>
      <label for="category" id="label-category">Category:</label>
      <select id="category"></select>
    </div>
    <div>
      <label for="model" id="label-model">Model:</label>
      <select id="model"></select>
    </div>
  </div>
  <div id="viewer-wrapper">
    <model-viewer
      id="viewer"
      camera-controls
      auto-rotate
      alt="3D model preview"
      shadow-intensity="1"
      ar
      ar-modes="scene-viewer webxr quick-look"
      min-camera-orbit="auto auto 1m"
      max-camera-orbit="auto auto 42m">
    </model-viewer>
  </div>
  <div class="bg-controls">
    <input type="file" id="bgUpload" accept="image/*">
    <button type="button" id="clearBgBtn">Clear Background</button>
  </div>
  <div class="desc" id="desc"></div>
  <script>
    function adjustViewerHeight() {
      const wrapper = document.getElementById('viewer-wrapper');
      const aspectRatio = 9 / 16;
      const width = wrapper.offsetWidth;
      let height = width * aspectRatio;
      if (height < 220) height = 220;
      if (height > 600) height = 600;
      wrapper.style.height = height + 'px';
    }
    window.addEventListener('resize', function() {
      if (!document.getElementById('viewer-wrapper').classList.contains('bg-has-img')) {
        adjustViewerHeight();
      }
    });
    window.addEventListener('DOMContentLoaded', adjustViewerHeight);

    // Ultra gentle zoom
    function setGentleZoomStep() {
      const viewer = document.getElementById('viewer');
      if (viewer && viewer.cameraControls) {
        viewer.cameraControls.dollyStep = 0.002;
        viewer.cameraControls.dollySpeed = 0.2;
      }
    }
    document.getElementById('viewer').addEventListener('load', setGentleZoomStep);
    function safeSetGentleZoomStep() { setTimeout(setGentleZoomStep, 100); }

    // Translations
    const translations = {
      en: {
        title: "3D Model Showcase",
        category: "Category:",
        model: "Model:",
        night: "ðŸŒ™ Night Mode",
        light: "â˜€ï¸ Light Mode",
        lang: "ðŸ‡®ðŸ‡± ×¢×‘×¨×™×ª",
        switchTo: "Switch to",
        desc: (cat, model, variant) => `Category: ${cat} | Model: ${model}${variant ? ' (' + variant + ')' : ''}`,
      },
      he: {
        title: "×ª×¦×•×’×ª ×ž×•×“×œ×™× ×‘×ª×œ×ª-×ž×ž×“",
        category: "×§×˜×’×•×¨×™×”:",
        model: "×ž×•×“×œ:",
        night: "ðŸŒ™ ×ž×¦×‘ ×œ×™×œ×”",
        light: "â˜€ï¸ ×ž×¦×‘ ×™×•×",
        lang: "ðŸ‡¬ðŸ‡§ English",
        switchTo: "×”×—×œ×£ ×œ",
        desc: (cat, model, variant) => `×§×˜×’×•×¨×™×”: ${cat} | ×ž×•×“×œ: ${model}${variant ? ' (' + variant + ')' : ''}`,
      }
    };
    const categoryLabels = {
      "Cabinets": { en: "Cabinets", he: "××¨×•× ×•×ª" },
      "Lamps": { en: "Lamps", he: "×ž× ×•×¨×•×ª" },
      "Sofas": { en: "Sofas", he: "×¡×¤×•×ª" },
      "Tables": { en: "Tables", he: "×©×•×œ×—× ×•×ª" }
    };
    const availableFiles = [
      "Cabinets/bookcase.glb",
      "Cabinets/closet_oak_white.glb",
      "Cabinets/ikea_alex_drawer.glb",
      "Lamps/floor_lamp.glb",
      "Lamps/mario_floor_lamp.glb",
      "Lamps/sweep_floor_lamp_black.glb",
      "Sofas/BLACKSofa.glb",
      "Sofas/dolton_armchair_hudson_grey.glb",
      "Sofas/sofawood.glb",
      "Sofas/wassily_chair.glb",
      "Tables/kumo_white_coffee_table.glb",
      "Tables/noguchi_coffee_table.glb"
    ];
    function fileExists(path) {
      return availableFiles.includes(path);
    }

    let lang = "en";
    let modelsData = {};
    let currentCategory = "";
    let currentModelIndex = 0;
    let currentVariantIndex = 0;

    function prettyCategory(cat) {
      return (categoryLabels[cat] && categoryLabels[cat][lang]) ? categoryLabels[cat][lang] : cat;
    }
    function prettyModel(modelObj) {
      if (!modelObj) return "";
      return lang === "he" ? (modelObj.label_he || modelObj.label_en || modelObj.name) : (modelObj.label_en || modelObj.name);
    }
    function prettyVariant(variantObj) {
      if (!variantObj) return "";
      return lang === "he" ? (variantObj.label_he || variantObj.label) : (variantObj.label || variantObj.label_he);
    }

    function setLanguage(newLang) {
      lang = newLang;
      document.getElementById('title').textContent = translations[lang].title;
      document.getElementById('label-category').textContent = translations[lang].category;
      document.getElementById('label-model').textContent = translations[lang].model;
      document.getElementById('langSwitch').textContent = translations[lang].lang;
      document.getElementById('langSwitch').setAttribute('aria-label',
        lang === "en" ? "Switch to Hebrew" : "Switch to English");
      const isNight = document.body.classList.contains('night');
      document.getElementById('nightSwitch').textContent = isNight ? translations[lang].light : translations[lang].night;
      document.getElementById('nightSwitch').setAttribute('aria-label',
        isNight ? (lang === "en" ? "Switch to Light Mode" : "×”×—×œ×£ ×œ×ž×¦×‘ ×™×•×") :
                  (lang === "en" ? "Switch to Night Mode" : "×”×—×œ×£ ×œ×ž×¦×‘ ×œ×™×œ×”"));
      renderCategoryDropdown();
      renderModelDropdown();
      updateViewer();
      document.body.dir = (lang === "he") ? "rtl" : "ltr";
    }
    function renderCategoryDropdown() {
      const catSel = document.getElementById('category');
      const cats = Object.keys(modelsData);
      catSel.innerHTML = '';
      cats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = prettyCategory(cat);
        catSel.appendChild(opt);
      });
      catSel.value = currentCategory;
    }
    function renderModelDropdown() {
      const modelSel = document.getElementById('model');
      if (!modelsData[currentCategory]) return;
      modelSel.innerHTML = '';
      modelsData[currentCategory].forEach((model, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = prettyModel(model);
        modelSel.appendChild(opt);
      });
      modelSel.selectedIndex = currentModelIndex;
    }
    function updateViewer() {
      const viewer = document.getElementById('viewer');
      const desc = document.getElementById('desc');
      const variantSwitch = document.getElementById('variantSwitch');
      const modelObj = modelsData[currentCategory][currentModelIndex];
      let modelFile = modelObj.file;
      let variantLabel = "";

      let hasValidVariants = false;
      let validVariants = [];
      if (modelObj.variants && Array.isArray(modelObj.variants)) {
        validVariants = modelObj.variants.filter(v => v.file && fileExists(v.file));
        hasValidVariants = validVariants.length >= 2;
        if (hasValidVariants) {
          if (currentVariantIndex >= validVariants.length) currentVariantIndex = 0;
          const variantObj = validVariants[currentVariantIndex];
          modelFile = variantObj.file;
          variantLabel = prettyVariant(variantObj);
          variantSwitch.style.display = '';
          const nextVariantObj = validVariants[(currentVariantIndex + 1) % validVariants.length];
          variantSwitch.textContent = translations[lang].switchTo + ' ' + prettyVariant(nextVariantObj);
        } else {
          currentVariantIndex = 0;
          variantSwitch.style.display = 'none';
        }
      } else {
        currentVariantIndex = 0;
        variantSwitch.style.display = 'none';
      }
      viewer.src = modelFile;
      viewer.alt = prettyModel(modelObj);

      // Always use auto auto X for min/max orbits for free zoom in/out
      viewer.removeAttribute('camera-orbit');
      viewer.removeAttribute('min-camera-orbit');
      viewer.removeAttribute('max-camera-orbit');
      if (modelObj.cameraOrbit) viewer.setAttribute('camera-orbit', modelObj.cameraOrbit);
      if (modelObj.minCameraOrbit) viewer.setAttribute('min-camera-orbit', modelObj.minCameraOrbit);
      if (modelObj.maxCameraOrbit) viewer.setAttribute('max-camera-orbit', modelObj.maxCameraOrbit);

      desc.textContent = translations[lang].desc(
        prettyCategory(currentCategory),
        prettyModel(modelObj),
        variantLabel
      );
      safeSetGentleZoomStep();
    }

    document.getElementById('langSwitch').onclick = function() {
      setLanguage(lang === "en" ? "he" : "en");
      safeSetGentleZoomStep();
    };
    document.getElementById('nightSwitch').onclick = function() {
      document.body.classList.toggle('night');
      const isNight = document.body.classList.contains('night');
      document.getElementById('nightSwitch').textContent = isNight ? translations[lang].light : translations[lang].night;
      safeSetGentleZoomStep();
    };
    document.getElementById('category').addEventListener('change', function() {
      currentCategory = this.value;
      currentModelIndex = 0;
      currentVariantIndex = 0;
      renderModelDropdown();
      updateViewer();
      safeSetGentleZoomStep();
    });
    document.getElementById('model').addEventListener('change', function() {
      currentModelIndex = +this.value;
      currentVariantIndex = 0;
      updateViewer();
      safeSetGentleZoomStep();
    });
    document.getElementById('variantSwitch').onclick = function () {
      const modelObj = modelsData[currentCategory][currentModelIndex];
      if (!modelObj.variants || !Array.isArray(modelObj.variants)) return;
      const validVariants = modelObj.variants.filter(v => v.file && fileExists(v.file));
      if (validVariants.length < 2) return;
      currentVariantIndex = (currentVariantIndex + 1) % validVariants.length;
      updateViewer();
      safeSetGentleZoomStep();
    };

    // When uploading a background, crop window to image aspect ratio
    document.getElementById('bgUpload').addEventListener('change', function(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const wrapper = document.getElementById('viewer-wrapper');
        const img = new Image();
        img.onload = function() {
          let viewportWidth = Math.min(window.innerWidth, 1200) * 0.85;
          if (window.innerWidth < 900) {
            viewportWidth = window.innerWidth * 0.99;
          }
          const aspect = img.height / img.width;
          let width = viewportWidth;
          let height = width * aspect;
          if (width < 250) width = 250;
          if (width > 1200) width = 1200;
          if (height < 220) height = 220;
          if (height > 600) height = 600;
          wrapper.style.width = width + 'px';
          wrapper.style.height = height + 'px';
          wrapper.classList.add('bg-has-img');
          wrapper.style.backgroundImage = `url('${e.target.result}')`;
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });
    document.getElementById('clearBgBtn').onclick = function() {
      const wrapper = document.getElementById('viewer-wrapper');
      wrapper.classList.remove('bg-has-img');
      wrapper.style.backgroundImage = '';
      document.getElementById('bgUpload').value = '';
      wrapper.style.width = '';
      wrapper.style.height = '';
      adjustViewerHeight();
    };

    fetch('models.json')
      .then(r => r.json())
      .then(data => {
        modelsData = data;
        currentCategory = Object.keys(modelsData)[0];
        currentModelIndex = 0;
        currentVariantIndex = 0;
        setLanguage(lang);
        adjustViewerHeight();
        safeSetGentleZoomStep();
      });
  </script>
</body>
</html>
