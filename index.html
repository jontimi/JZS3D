<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>3D Model Showcase</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root {
      --main-bg: #f5f7fa;
      --viewer-bg: #fff;
      --text-main: #222;
      --primary: #1976d2;
      --select-bg: #fff;
      --select-border: #bbb;
      --select-color: #222;
      --desc-color: #333;
      --shadow: 0 2px 16px #0001;
    }
    body.night {
      --main-bg: #181e28;
      --viewer-bg: #232b39;
      --text-main: #f3f6fa;
      --primary: #5caaff;
      --select-bg: #232b39;
      --select-border: #5caaff;
      --select-color: #f3f6fa;
      --desc-color: #a0bbd6;
      --shadow: 0 2px 16px #0004;
    }
    body {
      font-family: sans-serif;
      background: var(--main-bg);
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2em 0;
      color: var(--text-main);
      transition: background 0.35s, color 0.35s;
    }
    h1 {
      color: var(--primary);
      margin-bottom: 1em;
      transition: color 0.35s;
    }
    .controls {
      margin-bottom: 1.5em;
      display: flex;
      gap: 1em;
      flex-wrap: wrap;
      justify-content: center;
    }
    label {
      font-weight: bold;
      margin-right: 0.5em;
    }
    select {
      font-size: 1em;
      padding: 0.3em 0.7em;
      border-radius: 6px;
      border: 1px solid var(--select-border);
      background: var(--select-bg);
      color: var(--select-color);
      transition: background 0.35s, color 0.35s, border 0.35s;
    }
    #viewer-wrapper {
      width: 85vw;
      max-width: 1200px;
      min-width: 250px;
      height: 48vw;
      max-height: 600px;
      min-height: 220px;
      background: var(--viewer-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      margin-bottom: 2em;
      transition: background 0.35s, box-shadow 0.35s, height 0.3s, width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #viewer-wrapper.bg-has-img {
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    model-viewer {
      width: 100%;
      height: 100%;
      background: transparent;
      transition: filter 0.2s;
      pointer-events: auto;
    }
    /* Ensure AR button is not overlapped */
    model-viewer .container {
      pointer-events: none;
    }
    model-viewer .container * {
      pointer-events: auto;
    }
    /* Brightness/Contrast Controls as Popup */
    .filter-controls {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 1001;
      background: rgba(255,255,255,0.97);
      border-radius: 13px;
      box-shadow: 0 4px 24px #0003;
      padding: 18px 22px 16px 22px;
      display: none;
      flex-direction: row;
      gap: 18px;
      min-width: 220px;
      user-select: none;
      font-size: 1.05em;
      align-items: flex-start;
      transition: opacity 0.2s, visibility 0.2s;
    }
    .filter-controls.visible {
      display: flex;
    }
    .filter-controls .filter-slider-row {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
      min-width: 90px;
    }
    .filter-controls label {
      font-weight: normal;
      font-size: 1em;
      margin-right: 0.5em;
      margin-bottom: 2px;
    }
    .filter-controls input[type=range] {
      width: 90px;
      margin: 0 0 2px 0;
      accent-color: var(--primary);
      height: 2px;
    }
    .filter-value {
      min-width: 30px;
      text-align: right;
      font-size: 0.95em;
      opacity: 0.7;
      margin-left: 3px;
      font-variant-numeric: tabular-nums;
    }
    .filter-controls button {
      align-self: flex-end;
      margin-left: 10px;
      margin-top: 0;
    }
    .filter-popup-btn {
      position: absolute;
      top: 18px;
      left: 18px;
      z-index: 1002;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 0.45em 1.2em;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px #0002;
      opacity: 0.93;
      transition: background 0.2s, color 0.2s, opacity 0.2s;
    }
    .filter-popup-btn:hover, .filter-popup-btn:focus {
      background: #1e8fff;
      opacity: 1;
    }
    @media (max-width: 600px) {
      .filter-controls {
        min-width: 120px;
        padding: 10px 8px 10px 8px;
        font-size: 0.97em;
        flex-direction: column;
        gap: 8px;
      }
      .filter-controls .filter-slider-row {
        min-width: 0;
        width: 100%;
      }
      .filter-controls input[type=range] {
        width: 100%;
      }
      .filter-popup-btn {
        top: 10px;
        left: 10px;
        padding: 0.35em 0.9em;
        font-size: 0.95em;
      }
    }
    #resetViewBtn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      z-index: 30;
      padding: 0.5em 1.1em;
      border-radius: 24px;
      border: none;
      font-size: 1em;
      font-weight: 600;
      background: var(--primary);
      color: #fff;
      box-shadow: 0 2px 8px #0003;
      cursor: pointer;
      opacity: 0.93;
      transition: background 0.2s, color 0.2s, opacity 0.2s;
    }
    #resetViewBtn:hover, #resetViewBtn:focus {
      background: #1e8fff;
      opacity: 1;
    }
    body.night #resetViewBtn {
      background: #4098ff;
      color: #181e28;
    }
    body.night #resetViewBtn:hover, body.night #resetViewBtn:focus {
      background: #5caaff;
      color: #232b39;
    }
    body {
      font-family: sans-serif;
      background: var(--main-bg);
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2em 0;
      color: var(--text-main);
      transition: background 0.35s, color 0.35s;
    }
    h1 {
      color: var(--primary);
      margin-bottom: 1em;
      transition: color 0.35s;
    }
    .controls {
      margin-bottom: 1.5em;
      display: flex;
      gap: 1em;
      flex-wrap: wrap;
      justify-content: center;
    }
    label {
      font-weight: bold;
      margin-right: 0.5em;
    }
    select {
      font-size: 1em;
      padding: 0.3em 0.7em;
      border-radius: 6px;
      border: 1px solid var(--select-border);
      background: var(--select-bg);
      color: var(--select-color);
      transition: background 0.35s, color 0.35s, border 0.35s;
    }
    #viewer-wrapper {
      width: 85vw;
      max-width: 1200px;
      min-width: 250px;
      height: 48vw;
      max-height: 600px;
      min-height: 220px;
      background: var(--viewer-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      position: relative;
      margin-bottom: 2em;
      transition: background 0.35s, box-shadow 0.35s, height 0.3s, width 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #viewer-wrapper.bg-has-img {
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }
    model-viewer {
      width: 100%;
      height: 100%;
      background: transparent;
      transition: filter 0.2s;
      pointer-events: auto;
    }
    /* Ensure AR button is not overlapped */
    model-viewer .container {
      pointer-events: none;
    }
    model-viewer .container * {
      pointer-events: auto;
    }
    model-viewer::part(default-ar-button) {
      position: absolute;
      bottom: 16px;
      left: 16px;
      z-index: 31;
      /* Style to match reset button */
      background: var(--primary);
      color: #fff;
      border-radius: 24px;
      padding: 0.5em 1.1em;
      font-size: 1em;
      font-weight: 600;
      box-shadow: 0 2px 8px #0003;
      opacity: 0.93;
      border: none;
      transition: background 0.2s, color 0.2s, opacity 0.2s;
    }
    model-viewer::part(default-ar-button):hover, model-viewer::part(default-ar-button):focus {
      background: #1e8fff;
      opacity: 1;
    }
    body.night model-viewer::part(default-ar-button) {
      background: #4098ff;
      color: #181e28;
    }
    body.night model-viewer::part(default-ar-button):hover, body.night model-viewer::part(default-ar-button):focus {
      background: #5caaff;
      color: #232b39;
    }
    @media (max-width: 600px) {
      .filter-controls {
        min-width: 120px;
        padding: 5px 6px 5px 6px;
        font-size: 0.93em;
        flex-direction: column;
        gap: 8px;
      }
      .filter-controls .filter-slider-row {
        min-width: 0;
        width: 100%;
      }
      .filter-controls input[type=range] {
        width: 100%;
      }
    }
    #forceArBtn {
      position: absolute;
      bottom: 16px;
      left: 16px;
      z-index: 32;
      padding: 0.5em 1.1em;
      border-radius: 24px;
      border: none;
      font-size: 1em;
      font-weight: 600;
      background: var(--primary);
      color: #fff;
      box-shadow: 0 2px 8px #0003;
      cursor: pointer;
      opacity: 0.93;
      transition: background 0.2s, color 0.2s, opacity 0.2s;
    }
    #forceArBtn:hover, #forceArBtn:focus {
      background: #1e8fff;
      opacity: 1;
    }
    #arDialog {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #arDialog > div {
      background: #fff;
      padding: 2em 2.5em;
      border-radius: 18px;
      box-shadow: 0 4px 32px #0005;
      max-width: 95vw;
      text-align: center;
      position: relative;
    }
    #arDialog h2 {
      margin-top: 0;
    }
    #arDialog p {
      font-size: 1.1em;
      max-width: 350px;
      margin: auto;
    }
    #arQrContainer {
      margin: 1.5em auto 0 auto;
      display: block;
    }
    #closeArDialog {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.5em;
      background: none;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1 id="title">3D Model Showcase</h1>
  <div class="btn-bar">
    <button class="switch-btn" id="langSwitch" aria-label="Switch to Hebrew">üáÆüá± ◊¢◊ë◊®◊ô◊™</button>
    <button class="switch-btn" id="nightSwitch" aria-label="Switch to Night Mode">üåô Night Mode</button>
    <button class="switch-btn" id="variantSwitch" style="display:none"></button>
  </div>
  <div class="controls">
    <div>
      <label for="category" id="label-category">Category:</label>
      <select id="category"></select>
    </div>
    <div>
      <label for="model" id="label-model">Model:</label>
      <select id="model"></select>
    </div>
  </div>
  <div id="viewer-wrapper">
    <button class="filter-popup-btn" id="filterPopupBtn" title="Show Brightness/Contrast" aria-label="Show Brightness/Contrast">‚öôÔ∏è</button>
    <div class="filter-controls" id="filterControls">
      <div class="filter-slider-row">
        <label for="brightnessRange">Brightness</label>
        <input type="range" min="0.5" max="2.0" step="0.01" value="1.0" id="brightnessRange">
        <span class="filter-value" id="brightnessVal">1.00</span>
      </div>
      <div class="filter-slider-row">
        <label for="contrastRange">Contrast</label>
        <input type="range" min="0.5" max="2.0" step="0.01" value="1.0" id="contrastRange">
        <span class="filter-value" id="contrastVal">1.00</span>
      </div>
      <button type="button" style="margin-top:6px;font-size:0.95em;padding:0.2em 0.7em;border-radius:8px;border:1px solid #bbb;cursor:pointer" id="resetFiltersBtn">Reset</button>
    </div>
    <model-viewer
      id="viewer"
      camera-controls
      auto-rotate
      alt="3D model preview"
      shadow-intensity="1"
      ar
      ar-modes="scene-viewer webxr quick-look"
      max-camera-orbit="auto auto 100m"
      min-camera-orbit="auto auto 0.5m"
      camera-orbit="0deg 75deg 2.5m"
      field-of-view="45deg">
    </model-viewer>
    <button id="resetViewBtn" title="Reset View" aria-label="Reset View">üîÑ Reset View</button>
    <button id="forceArBtn" class="switch-btn" style="position:absolute;bottom:16px;left:16px;z-index:32;">AR</button>
  </div>
  <div class="bg-controls">
    <input type="file" id="bgUpload" accept="image/*">
    <button type="button" id="clearBgBtn">Clear Background</button>
  </div>
  <div class="desc" id="desc"></div>
  <div id="arDialog" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.55);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:2em 2.5em;border-radius:18px;box-shadow:0 4px 32px #0005;max-width:95vw;text-align:center;position:relative;">
      <button id="closeArDialog" style="position:absolute;top:10px;right:10px;font-size:1.5em;background:none;border:none;cursor:pointer;">‚úñ</button>
      <h2 style="margin-top:0">AR Not Supported</h2>
      <p style="font-size:1.1em;max-width:350px;margin:auto;">This device does not support AR. To view this model in AR, scan the QR code below with your phone or tablet.</p>
      <div id="arQrContainer" style="margin:1.5em auto 0 auto;display:block;"></div>
      <div style="margin-top:1.2em;font-size:0.98em;color:#555;">Open this page on your mobile device to use AR.</div>
    </div>
  </div>
  <script>
    // --- Brightness and Contrast Controls ---
    function updateFilters() {
      const bright = parseFloat(document.getElementById('brightnessRange').value);
      const contrast = parseFloat(document.getElementById('contrastRange').value);
      document.getElementById('viewer').style.filter = `brightness(${bright}) contrast(${contrast})`;
      document.getElementById('brightnessVal').textContent = bright.toFixed(2);
      document.getElementById('contrastVal').textContent = contrast.toFixed(2);
    }
    document.getElementById('brightnessRange').addEventListener('input', updateFilters);
    document.getElementById('contrastRange').addEventListener('input', updateFilters);
    document.getElementById('resetFiltersBtn').addEventListener('click', function() {
      document.getElementById('brightnessRange').value = 1.0;
      document.getElementById('contrastRange').value = 1.0;
      updateFilters();
    });
    document.getElementById('viewer').addEventListener('load', updateFilters);

    // --- Viewer Logic ---
    function adjustViewerHeight() {
      const wrapper = document.getElementById('viewer-wrapper');
      const aspectRatio = 9 / 16;
      const width = wrapper.offsetWidth;
      let height = width * aspectRatio;
      if (height < 220) height = 220;
      if (height > 600) height = 600;
      wrapper.style.height = height + 'px';
    }
    window.addEventListener('resize', function() {
      if (!document.getElementById('viewer-wrapper').classList.contains('bg-has-img')) {
        adjustViewerHeight();
      }
    });
    window.addEventListener('DOMContentLoaded', adjustViewerHeight);

    function setGentleZoomStep() {
      const viewer = document.getElementById('viewer');
      if (viewer && viewer.cameraControls) {
        viewer.cameraControls.dollyStep = 0.002;
        viewer.cameraControls.dollySpeed = 0.2;
      }
    }
    document.getElementById('viewer').addEventListener('load', setGentleZoomStep);
    function safeSetGentleZoomStep() { setTimeout(setGentleZoomStep, 100); }

    document.getElementById('resetViewBtn').onclick = function() {
      const viewer = document.getElementById('viewer');
      if (viewer) {
        viewer.resetTurntableRotation();
        viewer.jumpCameraToGoal();
        if (typeof viewer.resetCameraOrbit === 'function') {
          viewer.resetCameraOrbit();
        } else {
          // Fallback: set camera-orbit to default if resetCameraOrbit is not available
          viewer.removeAttribute('camera-orbit');
        }
      }
    };

    // DO NOT lock pan/zoom when background image is present!
    // Instead, always allow camera-controls, zoom, pan, etc.

    // --- AR Button and Dialog Logic ---
    const forceArBtn = document.getElementById('forceArBtn');
    const arDialog = document.getElementById('arDialog');
    const closeArDialog = document.getElementById('closeArDialog');
    const arQrContainer = document.getElementById('arQrContainer');

    function getCurrentModelUrl() {
      // Always return the production URL for the current model file
      const viewer = document.getElementById('viewer');
      let src = viewer.src;
      // Remove any leading slashes
      if (src.startsWith('/')) src = src.substring(1);
      // If src is a full URL already, extract the path after the domain
      if (src.match(/^https?:\/\//)) {
        const url = new URL(src);
        src = url.pathname;
        if (src.startsWith('/')) src = src.substring(1);
      }
      // Return the production URL (update this if your production domain changes)
      return 'https://jontimi.github.io/JZS-AR-SHOWCASE/' + src;
    }

    function getCurrentModelQueryUrl() {
      // Get the relative model file path
      const viewer = document.getElementById('viewer');
      let src = viewer.src;
      // If src is a full URL, extract the path after the domain
      if (src.match(/^https?:\/\//)) {
        const url = new URL(src);
        src = url.pathname;
        if (src.startsWith('/')) src = src.substring(1);
      }
      // If src is relative and starts with a slash, remove it
      if (src.startsWith('/')) src = src.substring(1);
      // Return the main site URL with ?model=...
      return 'https://jontimi.github.io/JZS-AR-SHOWCASE/?model=' + encodeURIComponent(src);
    }

    function showArDialog() {
      arDialog.style.display = 'flex';
      arQrContainer.innerHTML = '';
      // Generate QR code for the main site with ?model=... param
      const modelUrl = getCurrentModelQueryUrl();
      const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(modelUrl)}&size=200x200`;
      const img = new Image();
      img.src = qrCodeUrl;
      img.alt = 'QR code to open this model on your phone';
      img.style.display = 'block';
      img.style.margin = '0 auto';
      img.width = 200;
      img.height = 200;
      arQrContainer.appendChild(img);
    }

    forceArBtn.onclick = function() {
      showArDialog();
    };
    closeArDialog.onclick = function() {
      arDialog.style.display = 'none';
    };
    // Hide AR dialog on outside click
    // (use event delegation to avoid closing when clicking inside dialog)
    document.addEventListener('mousedown', function(e) {
      if (arDialog.style.display === 'flex' && !arDialog.contains(e.target) && e.target !== forceArBtn) {
        arDialog.style.display = 'none';
      }
    });
    // Hide AR dialog on ESC
    document.addEventListener('keydown', function(e) {
      if (arDialog.style.display === 'flex' && (e.key === 'Escape' || e.key === 'Esc')) {
        arDialog.style.display = 'none';
      }
    });

    // --- Brightness/Contrast Popup Logic ---
    const filterPopupBtn = document.getElementById('filterPopupBtn');
    const filterControls = document.getElementById('filterControls');
    let filterPopupOpen = false;
    function toggleFilterPopup(force) {
      filterPopupOpen = typeof force === 'boolean' ? force : !filterPopupOpen;
      if (filterPopupOpen) {
        filterControls.classList.add('visible');
        filterPopupBtn.setAttribute('aria-label', 'Hide Brightness/Contrast');
        filterPopupBtn.textContent = '‚úñ';
      } else {
        filterControls.classList.remove('visible');
        filterPopupBtn.setAttribute('aria-label', 'Show Brightness/Contrast');
        filterPopupBtn.textContent = '‚öôÔ∏è';
      }
    }
    filterPopupBtn.onclick = function(e) {
      e.stopPropagation();
      toggleFilterPopup();
    };
    // Hide popup if click outside
    document.addEventListener('mousedown', function(e) {
      if (filterPopupOpen && !filterControls.contains(e.target) && e.target !== filterPopupBtn) {
        toggleFilterPopup(false);
      }
    });
    // Hide popup on ESC
    document.addEventListener('keydown', function(e) {
      if (filterPopupOpen && (e.key === 'Escape' || e.key === 'Esc')) {
        toggleFilterPopup(false);
      }
    });
    // Set initial icon for filter popup button to gear
    filterPopupBtn.textContent = '‚öôÔ∏è';
    filterPopupBtn.title = 'Show Brightness/Contrast';
    filterPopupBtn.setAttribute('aria-label', 'Show Brightness/Contrast');

    // --- AR Button Logic ---
    function isArSupported() {
      // model-viewer AR support detection
      const a = document.createElement('a');
      return (
        navigator.userAgent.match(/android|iphone|ipad|ipod/i) &&
        (a.relList && a.relList.supports && a.relList.supports('ar'))
      ) || (window.navigator.xr && navigator.userAgent.match(/android|iphone|ipad|ipod/i));
    }
    function getArUrl() {
      // Compose the AR intent URL for Android/iOS
      const viewer = document.getElementById('viewer');
      const src = viewer.src;
      // Android Scene Viewer
      if (navigator.userAgent.match(/android/i)) {
        return `intent://arvr.google.com/scene-viewer/1.0?file=${location.origin + '/' + src}&mode=ar_preferred#Intent;scheme=https;package=com.google.ar.core;action=android.intent.action.VIEW;S.browser_fallback_url=${location.href};end;`;
      }
      // iOS Quick Look
      if (navigator.userAgent.match(/iphone|ipad|ipod/i)) {
        return location.origin + '/' + src;
      }
      // Fallback: just link to the model
      return location.origin + '/' + src;
    }

    // Load QRious for QR code generation
    (function(){
      if (!window.QRious) {
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js';
        document.head.appendChild(s);
      }
    })();

    // Translations and support code (unchanged)
    const translations = {
      en: {
        title: "3D Model Showcase",
        category: "Category:",
        model: "Model:",
        night: "üåô Night Mode",
        light: "‚òÄÔ∏è Light Mode",
        lang: "üáÆüá± ◊¢◊ë◊®◊ô◊™",
        switchTo: "Switch to",
        desc: (cat, model, variant) => `Category: ${cat} | Model: ${model}${variant ? ' (' + variant + ')' : ''}`,
        resetView: "üîÑ Reset View"
      },
      he: {
        title: "◊™◊¶◊ï◊í◊™ ◊û◊ï◊ì◊ú◊ô◊ù ◊ë◊™◊ú◊™-◊û◊û◊ì",
        category: "◊ß◊ò◊í◊ï◊®◊ô◊î:",
        model: "◊û◊ï◊ì◊ú:",
        night: "üåô ◊û◊¶◊ë ◊ú◊ô◊ú◊î",
        light: "‚òÄÔ∏è ◊û◊¶◊ë ◊ô◊ï◊ù",
        lang: "üá¨üáß English",
        switchTo: "◊î◊ó◊ú◊£ ◊ú",
        desc: (cat, model, variant) => `◊ß◊ò◊í◊ï◊®◊ô◊î: ${cat} | ◊û◊ï◊ì◊ú: ${model}${variant ? ' (' + variant + ')' : ''}`,
        resetView: "üîÑ ◊ê◊ô◊§◊ï◊° ◊™◊¶◊ï◊í◊î"
      }
    };
    const categoryLabels = {
      "Cabinets": { en: "Cabinets", he: "◊ê◊®◊ï◊†◊ï◊™" },
      "Lamps": { en: "Lamps", he: "◊û◊†◊ï◊®◊ï◊™" },
      "Sofas": { en: "Sofas", he: "◊°◊§◊ï◊™" },
      "Tables": { en: "Tables", he: "◊©◊ï◊ú◊ó◊†◊ï◊™" }
    };
    let lang = "en";
    let modelsData = {};
    let currentCategory = "";
    let currentModelIndex = 0;
    let currentVariantIndex = 0;

    function prettyCategory(cat) {
      return (categoryLabels[cat] && categoryLabels[cat][lang]) ? categoryLabels[cat][lang] : cat;
    }
    function prettyModel(modelObj) {
      if (!modelObj) return "";
      return lang === "he" ? (modelObj.label_he || modelObj.label_en || modelObj.name) : (modelObj.label_en || modelObj.name);
    }
    function prettyVariant(variantObj) {
      if (!variantObj) return "";
      return lang === "he" ? (variantObj.label_he || variantObj.label) : (variantObj.label || variantObj.label_he);
    }

    function setLanguage(newLang) {
      lang = newLang;
      document.getElementById('title').textContent = translations[lang].title;
      document.getElementById('label-category').textContent = translations[lang].category;
      document.getElementById('label-model').textContent = translations[lang].model;
      document.getElementById('langSwitch').textContent = translations[lang].lang;
      document.getElementById('langSwitch').setAttribute('aria-label',
        lang === "en" ? "Switch to Hebrew" : "Switch to English");
      const isNight = document.body.classList.contains('night');
      document.getElementById('nightSwitch').textContent = isNight ? translations[lang].light : translations[lang].night;
      document.getElementById('nightSwitch').setAttribute('aria-label',
        isNight ? (lang === "en" ? "Switch to Light Mode" : "◊î◊ó◊ú◊£ ◊ú◊û◊¶◊ë ◊ô◊ï◊ù") :
                  (lang === "en" ? "Switch to Night Mode" : "◊î◊ó◊ú◊£ ◊ú◊û◊¶◊ë ◊ú◊ô◊ú◊î"));
      document.getElementById('resetViewBtn').textContent = translations[lang].resetView;
      renderCategoryDropdown();
      renderModelDropdown();
      updateViewer();
      document.body.dir = (lang === "he") ? "rtl" : "ltr";
    }
    function renderCategoryDropdown() {
      const catSel = document.getElementById('category');
      const cats = Object.keys(modelsData);
      catSel.innerHTML = '';
      cats.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = prettyCategory(cat);
        catSel.appendChild(opt);
      });
      catSel.value = currentCategory;
    }
    function renderModelDropdown() {
      const modelSel = document.getElementById('model');
      if (!modelsData[currentCategory]) return;
      modelSel.innerHTML = '';
      modelsData[currentCategory].forEach((model, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = prettyModel(model);
        modelSel.appendChild(opt);
      });
      modelSel.selectedIndex = currentModelIndex;
    }
    function updateViewer() {
      const viewer = document.getElementById('viewer');
      const desc = document.getElementById('desc');
      const variantSwitch = document.getElementById('variantSwitch');
      const modelObj = modelsData[currentCategory][currentModelIndex];
      let modelFile = modelObj.file;
      let variantLabel = "";

      let hasValidVariants = false;
      let validVariants = [];
      if (modelObj.variants && Array.isArray(modelObj.variants)) {
        validVariants = modelObj.variants.filter(v => v.file);
        hasValidVariants = validVariants.length >= 2;
        if (hasValidVariants) {
          if (currentVariantIndex >= validVariants.length) currentVariantIndex = 0;
          const variantObj = validVariants[currentVariantIndex];
          modelFile = variantObj.file;
          variantLabel = prettyVariant(variantObj);
          variantSwitch.style.display = '';
          const nextVariantObj = validVariants[(currentVariantIndex + 1) % validVariants.length];
          variantSwitch.textContent = translations[lang].switchTo + ' ' + prettyVariant(nextVariantObj);
        } else {
          currentVariantIndex = 0;
          variantSwitch.style.display = 'none';
        }
      } else {
        currentVariantIndex = 0;
        variantSwitch.style.display = 'none';
      }
      viewer.src = modelFile;
      viewer.alt = prettyModel(modelObj);

      // Always allow zoom and pan
      viewer.removeAttribute('min-camera-orbit');
      viewer.setAttribute('max-camera-orbit', 'auto auto 100m');
      viewer.setAttribute('min-camera-orbit', 'auto auto 0.5m');
      viewer.removeAttribute('disable-pan');

      desc.textContent = translations[lang].desc(
        prettyCategory(currentCategory),
        prettyModel(modelObj),
        variantLabel
      );
      safeSetGentleZoomStep();
    }

    document.getElementById('langSwitch').onclick = function() {
      setLanguage(lang === "en" ? "he" : "en");
      safeSetGentleZoomStep();
    };
    document.getElementById('nightSwitch').onclick = function() {
      document.body.classList.toggle('night');
      const isNight = document.body.classList.contains('night');
      document.getElementById('nightSwitch').textContent = isNight ? translations[lang].light : translations[lang].night;
      safeSetGentleZoomStep();
    };
    document.getElementById('category').addEventListener('change', function() {
      currentCategory = this.value;
      currentModelIndex = 0;
      currentVariantIndex = 0;
      renderModelDropdown();
      updateViewer();
      safeSetGentleZoomStep();
    });
    document.getElementById('model').addEventListener('change', function() {
      currentModelIndex = +this.value;
      currentVariantIndex = 0;
      updateViewer();
      safeSetGentleZoomStep();
    });
    document.getElementById('variantSwitch').onclick = function () {
      const modelObj = modelsData[currentCategory][currentModelIndex];
      if (!modelObj.variants || !Array.isArray(modelObj.variants)) return;
      const validVariants = modelObj.variants.filter(v => v.file);
      if (validVariants.length < 2) return;
      currentVariantIndex = (currentVariantIndex + 1) % validVariants.length;
      updateViewer();
      safeSetGentleZoomStep();
    };

    // When uploading a background, crop window to image aspect ratio but DO NOT restrict zoom/pan/orbit
    document.getElementById('bgUpload').addEventListener('change', function(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const wrapper = document.getElementById('viewer-wrapper');
        const img = new Image();
        img.onload = function() {
          // Set viewer to image aspect ratio
          let viewportWidth = Math.min(window.innerWidth, 1200) * 0.85;
          if (window.innerWidth < 900) {
            viewportWidth = window.innerWidth * 0.99;
          }
          const aspect = img.height / img.width;
          let width = viewportWidth;
          let height = width * aspect;
          if (width < 250) width = 250;
          if (width > 1200) width = 1200;
          if (height < 220) height = 220;
          if (height > 600) height = 600;
          wrapper.style.width = width + 'px';
          wrapper.style.height = height + 'px';
          wrapper.classList.add('bg-has-img');
          wrapper.style.backgroundImage = `url('${e.target.result}')`;

          // DO NOT restrict controls: always allow orbit, zoom, pan
          const viewer = document.getElementById('viewer');
          viewer.removeAttribute('min-camera-orbit');
          viewer.setAttribute('max-camera-orbit', 'auto auto 24m');
          viewer.removeAttribute('disable-pan');
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    document.getElementById('clearBgBtn').onclick = function() {
      const wrapper = document.getElementById('viewer-wrapper');
      wrapper.classList.remove('bg-has-img');
      wrapper.style.backgroundImage = '';
      document.getElementById('bgUpload').value = '';
      wrapper.style.width = '';
      wrapper.style.height = '';
      adjustViewerHeight();

      // Always allow free controls
      const viewer = document.getElementById('viewer');
      viewer.removeAttribute('min-camera-orbit');
      viewer.setAttribute('max-camera-orbit', 'auto auto 24m');
      viewer.removeAttribute('disable-pan');
    };

    // Auto-frame model on load (reset camera)
    document.getElementById('viewer').addEventListener('model-visibility', function() {
      const viewer = document.getElementById('viewer');
      if (viewer) {
        viewer.resetTurntableRotation();
        viewer.jumpCameraToGoal();
      }
    });

    // Load models.json and initialize
    fetch('models.json')
      .then(r => r.json())
      .then(data => {
        modelsData = data;
        currentCategory = Object.keys(modelsData)[0];
        currentModelIndex = 0;
        currentVariantIndex = 0;
        setLanguage(lang);
        adjustViewerHeight();
        safeSetGentleZoomStep();
      })
      .catch(err => {
        document.getElementById('desc').textContent =
          "Failed to load models.json. Please check that it exists and is valid.";
      });

    document.getElementById('viewer').addEventListener('load', function() {
      const viewer = document.getElementById('viewer');
      if (viewer.model && viewer.model.materials) {
        viewer.model.materials.forEach(mat => {
          mat.doubleSided = true;
        });
      }
    });

    // Toggle filter controls popup
    document.getElementById('filterPopupBtn').onclick = function() {
      const filterControls = document.getElementById('filterControls');
      filterControls.classList.toggle('visible');
    };

    // On page load, check for ?model=... and load that model if present
    window.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      const modelParam = params.get('model');
      if (modelParam) {
        // Find the category and model index for this file
        fetch('models.json')
          .then(r => r.json())
          .then(data => {
            let found = false;
            for (const cat in data) {
              const idx = data[cat].findIndex(m => m.file === modelParam);
              if (idx !== -1) {
                currentCategory = cat;
                currentModelIndex = idx;
                currentVariantIndex = 0;
                found = true;
                break;
              }
            }
            if (found) {
              setLanguage(lang); // re-render UI
            }
          });
      }
    });
  </script>
</body>
</html>
